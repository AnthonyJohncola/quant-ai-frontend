<script>

const backend = "https://quant-ai-backend-production.up.railway.app";
const watchTickers = ["AAPL","MSFT","NVDA","TSLA","AMZN","GOOGL","META","SPY"];

// ============================
// MAIN ANALYSIS (Lazy Load MC)
// ============================

async function analyze(tickerOverride=null) {

    let preset = document.getElementById("presetStocks").value;
    let ticker = tickerOverride || preset;
    if (!ticker) return;

    // 1️⃣ FAST LITE LOAD
    const liteRes = await fetch(`${backend}/analyze/${ticker}?lite=true`);
    const liteData = await liteRes.json();

    renderMainPanelLite(liteData);

    // 2️⃣ BACKGROUND FULL LOAD
    fetch(`${backend}/analyze/${ticker}`)
        .then(res => res.json())
        .then(fullData => {
            if (fullData.simulations) {
                drawMonteCarlo(fullData.simulations);
            }
        });
}

function renderMainPanelLite(data) {

    document.getElementById("mainPanel").innerHTML = `
        <div class="card">
            <h2>${data.ticker}</h2>
            <div class="score">${data.signal_score.toFixed(1)}</div>
            <div>${data.signal_label} | ${data.trend_regime}</div>
            <div style="margin-top:20px;">Loading Monte Carlo...</div>
            <canvas id="mcChart" width="800" height="250"></canvas>
        </div>
    `;
}

// ============================
// MONTE CARLO (Reduced Draw)
// ============================

function drawMonteCarlo(simulations) {

    const canvas = document.getElementById("mcChart");
    if (!canvas) return;

    const ctx = canvas.getContext("2d");
    ctx.clearRect(0,0,canvas.width,canvas.height);

    ctx.strokeStyle = "rgba(34,197,94,0.15)";

    simulations.slice(0,40).forEach(path => {
        ctx.beginPath();
        path.forEach((price,i)=>{
            let x = (i/path.length)*canvas.width;
            let y = canvas.height - (price/path[0])*150;
            if(i===0) ctx.moveTo(x,y);
            else ctx.lineTo(x,y);
        });
        ctx.stroke();
    });
}

// ============================
// PARALLEL WATCHLIST LOAD
// ============================

async function loadWatchlist() {

    const promises = watchTickers.map(t =>
        fetch(`${backend}/analyze/${t}?lite=true`)
            .then(r=>r.json())
    );

    const results = await Promise.all(promises);

    let totalScore = 0;
    document.getElementById("watchlist").innerHTML = "";
    document.getElementById("heatmap").innerHTML = "";

    results.forEach((d,i)=>{

        totalScore += d.signal_score;
        let t = watchTickers[i];

        let color = "#facc15";
        if (d.signal_score > 60) color = "#22c55e";
        if (d.signal_score < 40) color = "#ef4444";

        document.getElementById("watchlist").innerHTML += `
            <div class="watch-card" onclick="analyze('${t}')">
                ${t}<br>
                <span style="color:${color}; font-weight:bold;">
                ${d.signal_score.toFixed(0)}
                </span>
            </div>
        `;

        document.getElementById("heatmap").innerHTML += `
            <div class="heat-cell" style="background:${color}">
                ${t}<br>${d.signal_score.toFixed(0)}
            </div>
        `;
    });

    let avgScore = totalScore / watchTickers.length;

    document.getElementById("portfolioPanel").innerHTML = `
        <div class="card">
            Average Watchlist Score:
            <div class="score">${avgScore.toFixed(1)}</div>
        </div>
    `;
}

loadWatchlist();

</script>

