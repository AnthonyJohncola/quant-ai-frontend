<!DOCTYPE html>
<html>
<head>
<title>Quant AI Terminal</title>
<style>
body {
    font-family: Arial;
    background-color: #0f172a;
    color: white;
    padding: 30px;
}
.card {
    background: #1e293b;
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 25px;
}
.score {
    font-size: 70px;
    text-align: center;
    font-weight: bold;
}
.watchlist-grid, .heatmap {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
}
.watch-card, .heat-cell {
    background: #1e293b;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
}
canvas {
    margin-top: 20px;
    background: #0f172a;
    border-radius: 8px;
}
</style>
</head>
<body>

<h1>Quant AI Terminal</h1>

<select id="presetStocks" onchange="analyze()">
<option value="">Select Stock</option>
<option value="AAPL">AAPL</option>
<option value="MSFT">MSFT</option>
<option value="NVDA">NVDA</option>
<option value="TSLA">TSLA</option>
<option value="AMZN">AMZN</option>
<option value="GOOGL">GOOGL</option>
<option value="META">META</option>
<option value="SPY">SPY</option>
</select>

<button onclick="analyze()">Analyze</button>

<div id="mainPanel"></div>
<h2>Watchlist Overview</h2>
<div id="watchlist" class="watchlist-grid"></div>
<h2>Sector Heatmap</h2>
<div id="heatmap" class="heatmap"></div>
<div id="portfolioPanel"></div>

<script>

const backend = "https://quant-ai-backend-production.up.railway.app";
const watchTickers = ["AAPL","MSFT","NVDA","TSLA","AMZN","GOOGL","META","SPY"];

// MAIN ANALYSIS
async function analyze(tickerOverride=null) {

    let preset = document.getElementById("presetStocks").value;
    let ticker = tickerOverride || preset;
    if (!ticker) return;

    const res = await fetch(`${backend}/analyze/${ticker}`);
    const data = await res.json();

    renderMainPanel(data);
}

function renderMainPanel(data) {

    document.getElementById("mainPanel").innerHTML = `
        <div class="card">
            <h2>${data.ticker}</h2>
            <div class="score">${data.signal_score.toFixed(1)}</div>
            <div>${data.signal_label} | ${data.trend_regime}</div>
            <canvas id="mcChart" width="800" height="250"></canvas>
        </div>
    `;

    if (data.simulations) {
        drawMonteCarlo(data.simulations);
    }
}

// REDUCED DRAW LOAD
function drawMonteCarlo(simulations) {

    const canvas = document.getElementById("mcChart");
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0,0,canvas.width,canvas.height);

    ctx.strokeStyle = "rgba(34,197,94,0.15)";

    simulations.slice(0,40).forEach(path => {
        ctx.beginPath();
        path.forEach((price,i)=>{
            let x = (i/path.length)*canvas.width;
            let y = canvas.height - (price/path[0])*150;
            if(i===0) ctx.moveTo(x,y);
            else ctx.lineTo(x,y);
        });
        ctx.stroke();
    });
}

// PARALLEL WATCHLIST LOAD
async function loadWatchlist() {

    const promises = watchTickers.map(t =>
        fetch(`${backend}/analyze/${t}?lite=true`)
            .then(r=>r.json())
    );

    const results = await Promise.all(promises);

    let totalScore = 0;
    document.getElementById("watchlist").innerHTML = "";
    document.getElementById("heatmap").innerHTML = "";

    results.forEach((d,i)=>{

        totalScore += d.signal_score;
        let t = watchTickers[i];

        let color = "#facc15";
        if (d.signal_score > 60) color = "#22c55e";
        if (d.signal_score < 40) color = "#ef4444";

        document.getElementById("watchlist").innerHTML += `
            <div class="watch-card" onclick="analyze('${t}')">
                ${t}<br>
                <span style="color:${color}; font-weight:bold;">
                ${d.signal_score.toFixed(0)}
                </span>
            </div>
        `;

        document.getElementById("heatmap").innerHTML += `
            <div class="heat-cell" style="background:${color}">
                ${t}<br>${d.signal_score.toFixed(0)}
            </div>
        `;
    });

    let avgScore = totalScore / watchTickers.length;

    document.getElementById("portfolioPanel").innerHTML = `
        <div class="card">
            Average Watchlist Score:
            <div class="score">${avgScore.toFixed(1)}</div>
        </div>
    `;
}

loadWatchlist();

</script>

</body>
</html>

